{% extends 'attendance/base.html' %}
{% load static %}

{% block title %}Управление учениками{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'attendance/css/manage_students.css' %}">
{% endblock %}

{% block content %}
<div class="card page-wide">
  <div class="card-header">
    <h1>Управление учениками</h1>
    <p class="card-subtitle">
      Отмечайте льготников и удаляйте учеников. Удаление — мягкое (ученик становится неактивным, история посещаемости сохраняется).
    </p>
  </div>

  <div class="card-section">
    <!-- ФИЛЬТРЫ (GET) -->
    <div class="toolbar">
      <form method="get" class="filters">
        <label>
          Поиск (ФИО / класс):
          <input type="text" name="q" value="{{ q }}" class="input" placeholder="Например: Иванов или 3Б">
        </label>

        <label>
          Класс:
          <select name="class_id" class="input">
            <option value="">Все</option>
            {% for c in classes %}
              <option value="{{ c.id }}" {% if class_id == c.id|stringformat:"s" %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </label>

        <label>
          Сортировка:
          <select name="sort" class="input">
            <option value="class_asc"  {% if sort == 'class_asc' %}selected{% endif %}>Класс ↑, ФИО ↑</option>
            <option value="class_desc" {% if sort == 'class_desc' %}selected{% endif %}>Класс ↓, ФИО ↑</option>
            <option value="name_asc"   {% if sort == 'name_asc' %}selected{% endif %}>ФИО ↑</option>
            <option value="name_desc"  {% if sort == 'name_desc' %}selected{% endif %}>ФИО ↓</option>
          </select>
        </label>

        <label class="inline">
          <input type="checkbox" name="show_inactive" value="1" {% if show_inactive %}checked{% endif %}>
          Показать удалённых
        </label>

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Применить
        </button>
      </form>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
        <label style="display:flex; flex-direction:column; gap:6px;">
          Быстрый фильтр на странице:
          <input id="client-search" type="text" class="input" placeholder="Фильтр без перезагрузки">
        </label>

        <span class="counter-pill muted-small" title="Количество строк, видимых на странице">
          <i class="bi bi-people"></i>
          Видимых: <span id="visible-count">0</span>
        </span>
      </div>
    </div>

    <!-- BULK (POST) -->
    <form method="post" id="bulk-form">
      {% csrf_token %}

      <div class="actions-bar">
        <div class="actions-left">
          <button type="button" class="btn btn-outline" id="check-all">
            <i class="bi bi-check2-square"></i> Выбрать всё
          </button>
          <button type="button" class="btn btn-outline" id="uncheck-all">
            <i class="bi bi-square"></i> Снять выбор
          </button>

          <span class="counter-pill muted-small">
            <i class="bi bi-check-circle"></i>
            Выбрано: <span id="selected-count">0</span>
          </span>
        </div>

        <div class="actions-right">
          <select name="action" class="input" required>
            <option value="">— Действие —</option>

            <option value="priv_svo">Назначить: СВО</option>
            <option value="priv_multi">Назначить: Многодетные</option>
            <option value="priv_low_income">Назначить: Малоимущие</option>
            <option value="priv_disabled">Назначить: Инвалиды</option>
            <option value="priv_off">Снять льготу</option>

            <option value="delete">Удалить (деактивировать)</option>
            <option value="restore">Восстановить (активировать)</option>
          </select>

          <button type="submit" class="btn btn-primary">
            <i class="bi bi-play-fill"></i> Выполнить
          </button>
        </div>
      </div>
    </form>

    <!-- ✅ Таблица учеников -->
    <div class="table-wrapper" id="students-grid">
      <table class="table table-main manage-table">
        <thead>
          <tr>
            <th style="width:90px;">Выбор</th>
            <th style="width:110px;">Класс</th>
            <th>Ученик</th>
            <th style="min-width:220px;">Статусы</th>
            <th style="min-width:240px;">Льгота (тип)</th>
            <th style="width:180px;">Действия</th>
          </tr>
        </thead>

        <tbody>
          {% for s in students %}
            <tr class="student-row student-card {% if not s.is_active %}is-inactive{% endif %}"
                data-class="{{ s.class_room.name|lower }}"
                data-name="{{ s.full_name|lower }}"
                data-active="{{ s.is_active|yesno:'1,0' }}"
                data-priv-type="{{ s.privilege_type|default:'' }}">

              <!-- Выбор -->
              <td>
                <label class="pick" title="Выбрать для массового действия" style="display:flex; gap:8px; align-items:center;">
                  <input type="checkbox"
                         class="student-check"
                         name="student_ids"
                         value="{{ s.id }}"
                         form="bulk-form">
                  <span class="muted-small">выбрать</span>
                </label>
              </td>

              <!-- Класс -->
              <td>
                <span class="badge" title="Класс">
                  <i class="bi bi-mortarboard"></i>
                  <strong>{{ s.class_room.name }}</strong>
                </span>
              </td>

              <!-- ФИО -->
              <td>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <span class="muted-small"><i class="bi bi-person"></i></span>
                  <span class="text-bold">{{ s.full_name }}</span>
                </div>
              </td>

              <!-- Статусы -->
              <td>
                <div class="head-badges" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  {% if s.is_active %}
                    <span class="badge badge-success" title="Ученик активен">
                      <i class="bi bi-check-circle"></i> Активен
                    </span>
                  {% else %}
                    <span class="badge badge-danger" title="Ученик удалён (неактивен)">
                      <i class="bi bi-x-circle"></i> Удалён
                    </span>
                  {% endif %}

                  {% if s.privilege_type %}
                    <span class="badge badge-warn" title="Льготник">
                      <i class="bi bi-star-fill"></i> Льготник
                    </span>
                  {% endif %}
                </div>
              </td>

              <!-- Льгота: тип + модалка -->
              <td>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  {% if s.privilege_type %}
                    <span class="badge badge-warn">
                      <i class="bi bi-bookmark-star"></i> {{ s.get_privilege_type_display }}
                    </span>
                  {% else %}
                    <span class="muted">Не задано</span>
                  {% endif %}

                  <button type="button"
                          class="btn btn-small btn-outline js-open-priv-type"
                          data-student-id="{{ s.id }}"
                          data-student-name="{{ s.full_name }}"
                          data-current-type="{{ s.privilege_type|default:'' }}">
                    Изменить
                  </button>
                </div>
              </td>

              <!-- Действия -->
              <td>
                <div class="btn-row" style="display:flex; gap:8px; flex-wrap:wrap;">
                  {% if s.is_active %}
                    <button type="button"
                            class="btn btn-small btn-outline js-one-action"
                            data-action="delete"
                            data-student-id="{{ s.id }}">
                      <i class="bi bi-trash"></i> Удалить
                    </button>
                  {% else %}
                    <button type="button"
                            class="btn btn-small btn-outline js-one-action"
                            data-action="restore"
                            data-student-id="{{ s.id }}">
                      <i class="bi bi-arrow-counterclockwise"></i> Восстановить
                    </button>
                  {% endif %}
                </div>
              </td>

            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center muted">Ученики не найдены</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Одна скрытая форма для удаления/восстановления одного ученика -->
    <form method="post" id="one-action-form" style="display:none;">
      {% csrf_token %}
      <input type="hidden" name="action" id="one-action-type">
      <input type="hidden" name="student_ids" id="one-action-id">
    </form>

    <!-- ✅ hidden form для установки типа льготы -->
    <form method="post" id="priv-type-form" style="display:none;">
      {% csrf_token %}
      <input type="hidden" name="action" value="set_privilege_type">
      <input type="hidden" name="student_id" id="priv-type-student-id">
      <input type="hidden" name="privilege_type" id="priv-type-value">
    </form>

    <!-- ✅ модалка выбора типа льготы -->
    <div id="priv-type-modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h2>Тип льготы</h2>
          <div id="priv-type-subtitle" class="muted modal-subtitle"></div>
        </div>

        <div class="modal-body">
          <div id="priv-type-list" class="students-list" style="max-height: 320px;">
            <label class="student-row">
              <input type="radio" name="priv_type" value="svo">
              <span>СВО</span>
            </label>
            <label class="student-row">
              <input type="radio" name="priv_type" value="multi">
              <span>Многодетные</span>
            </label>
            <label class="student-row">
              <input type="radio" name="priv_type" value="low_income">
              <span>Малоимущие</span>
            </label>
            <label class="student-row">
              <input type="radio" name="priv_type" value="disabled">
              <span>Инвалиды</span>
            </label>
          </div>

          <div class="muted" style="margin-top:10px;">
            Выберите тип и нажмите «Сохранить». Чтобы полностью снять льготу — «Снять льготу».
          </div>
        </div>

        <div class="modal-footer" style="justify-content: space-between;">
          <button type="button" id="priv-type-clear" class="btn btn-outline">Снять льготу</button>
          <div style="display:flex; gap:8px;">
            <button type="button" id="priv-type-cancel" class="btn btn-outline">Отмена</button>
            <button type="button" id="priv-type-apply" class="btn btn-primary">Сохранить</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="{% static 'attendance/js/manage_students.js' %}"></script>
{% endblock %}