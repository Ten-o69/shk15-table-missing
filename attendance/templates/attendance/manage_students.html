{% extends 'attendance/base.html' %}
{% load static %}

{% block title %}Управление учениками{% endblock %}

{% block content %}
<div class="card page-wide">
  <div class="card-header">
    <h1>Управление учениками</h1>
    <p class="card-subtitle">
      Отмечайте льготников и удаляйте учеников. Удаление — мягкое (ученик становится неактивным, история посещаемости сохраняется).
    </p>
  </div>

  <div class="card-section">
    <!-- ФИЛЬТРЫ (GET) -->
    <div class="toolbar">
      <form method="get" class="filters">
        <label>
          Поиск (ФИО / класс):
          <input type="text" name="q" value="{{ q }}" class="input" placeholder="Например: Иванов или 3Б">
        </label>

        <label>
          Класс:
          <select name="class_id" class="input">
            <option value="">Все</option>
            {% for c in classes %}
              <option value="{{ c.id }}" {% if class_id == c.id|stringformat:"s" %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </label>

        <label>
          Сортировка:
          <select name="sort" class="input">
            <option value="class_asc"  {% if sort == 'class_asc' %}selected{% endif %}>Класс ↑, ФИО ↑</option>
            <option value="class_desc" {% if sort == 'class_desc' %}selected{% endif %}>Класс ↓, ФИО ↑</option>
            <option value="name_asc"   {% if sort == 'name_asc' %}selected{% endif %}>ФИО ↑</option>
            <option value="name_desc"  {% if sort == 'name_desc' %}selected{% endif %}>ФИО ↓</option>
          </select>
        </label>

        <label class="inline">
          <input type="checkbox" name="show_inactive" value="1" {% if show_inactive %}checked{% endif %}>
          Показать удалённых
        </label>

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Применить
        </button>
      </form>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
        <label style="display:flex; flex-direction:column; gap:6px;">
          Быстрый фильтр на странице:
          <input id="client-search" type="text" class="input" placeholder="Фильтр без перезагрузки">
        </label>

        <span class="counter-pill muted-small" title="Количество карточек, видимых на странице">
          <i class="bi bi-people"></i>
          Видимых: <span id="visible-count">0</span>
        </span>
      </div>
    </div>

    <!-- BULK (POST) -->
    <form method="post" id="bulk-form">
      {% csrf_token %}

      <div class="actions-bar">
        <div class="actions-left">
          <button type="button" class="btn btn-outline" id="check-all">
            <i class="bi bi-check2-square"></i> Выбрать всё
          </button>
          <button type="button" class="btn btn-outline" id="uncheck-all">
            <i class="bi bi-square"></i> Снять выбор
          </button>

          <span class="counter-pill muted-small">
            <i class="bi bi-check-circle"></i>
            Выбрано: <span id="selected-count">0</span>
          </span>
        </div>

        <div class="actions-right">
          <select name="action" class="input" required>
            <option value="">— Действие —</option>
            <option value="priv_on">Отметить льготниками</option>
            <option value="priv_off">Снять льготу</option>
            <option value="delete">Удалить (деактивировать)</option>
            <option value="restore">Восстановить (активировать)</option>
          </select>

          <button type="submit" class="btn btn-primary">
            <i class="bi bi-play-fill"></i> Выполнить
          </button>
        </div>
      </div>
    </form>

    <!-- Карточки учеников -->
    <div class="student-grid" id="students-grid">
      {% for s in students %}
        <div class="student-card {% if not s.is_active %}is-inactive{% endif %}"
             data-class="{{ s.class_room.name|lower }}"
             data-name="{{ s.full_name|lower }}"
             data-active="{{ s.is_active|yesno:'1,0' }}"
             data-priv="{{ s.is_privileged|yesno:'1,0' }}">

          <div class="student-card-head">
            <label class="pick" title="Выбрать для массового действия">
              <input type="checkbox"
                     class="student-check"
                     name="student_ids"
                     value="{{ s.id }}"
                     form="bulk-form">
              <span class="muted-small">выбрать</span>
            </label>

            <div class="head-badges">
              <span class="badge" title="Класс">
                <i class="bi bi-mortarboard"></i>
                <strong>{{ s.class_room.name }}</strong>
              </span>

              {% if s.is_active %}
                <span class="badge badge-success" title="Ученик активен">
                  <i class="bi bi-check-circle"></i> Активен
                </span>
              {% else %}
                <span class="badge badge-danger" title="Ученик удалён (неактивен)">
                  <i class="bi bi-x-circle"></i> Удалён
                </span>
              {% endif %}

              {% if s.is_privileged %}
                <span class="badge badge-warn" title="Льготник">
                  <i class="bi bi-star-fill"></i> Льготник
                </span>
              {% endif %}
            </div>
          </div>

          <div class="student-name">
            <i class="bi bi-person"></i>
            <span>{{ s.full_name }}</span>
          </div>

          <div class="student-card-foot">
            <!-- toggle льготника отдельной формой -->
            <form method="post" class="toggle-priv">
              {% csrf_token %}
              <input type="hidden" name="action" value="toggle_privileged">
              <input type="hidden" name="student_id" value="{{ s.id }}">
              <label class="toggle-priv" title="Отметить/снять льготу">
                <input type="checkbox"
                       name="is_privileged"
                       value="1"
                       onchange="this.form.submit()"
                       {% if s.is_privileged %}checked{% endif %}>
                <span class="muted-small">льгота</span>
              </label>
            </form>

            <div class="btn-row">
              {% if s.is_active %}
                <button type="button"
                        class="btn btn-small btn-outline js-one-action"
                        data-action="delete"
                        data-student-id="{{ s.id }}">
                  <i class="bi bi-trash"></i> Удалить
                </button>
              {% else %}
                <button type="button"
                        class="btn btn-small btn-outline js-one-action"
                        data-action="restore"
                        data-student-id="{{ s.id }}">
                  <i class="bi bi-arrow-counterclockwise"></i> Восстановить
                </button>
              {% endif %}
            </div>
          </div>

        </div>
      {% empty %}
        <div class="muted">Ученики не найдены</div>
      {% endfor %}
    </div>

    <!-- Одна скрытая форма для удаления/восстановления одного ученика -->
    <form method="post" id="one-action-form" style="display:none;">
      {% csrf_token %}
      <input type="hidden" name="action" id="one-action-type">
      <input type="hidden" name="student_ids" id="one-action-id">
    </form>
  </div>
</div>

<script src="{% static 'attendance/js/manage_students.js' %}"></script>
{% endblock %}