{% extends 'attendance/base.html' %}
{% load static %}
{% load attendance_tags %}

{% block title %}Статистика посещаемости{% endblock %}

{% block content %}
<style>
    .card.page-wide {
        width: min(1600px, 100% - 2rem);
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .card.page-wide {
            width: 100%;
            margin: 0;
            border-radius: 0;
        }
    }

    .table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .table-compact {
        table-layout: fixed;
        width: 100%;
        font-size: clamp(0.78rem, 0.78rem + 0.25vw, 1rem);
    }

    .table-compact th,
    .table-compact td {
        white-space: normal;
        word-wrap: break-word;
        padding:
            clamp(0.25rem, 0.35rem + 0.2vw, 0.6rem)
            clamp(0.35rem, 0.5rem + 0.2vw, 1rem);
    }

    .daily-summary {
        font-size: clamp(0.8rem, 0.8rem + 0.15vw, 0.95rem);
        flex-wrap: wrap;
        gap: 0.4rem;
    }
</style>

<div class="card page-wide">
    <div class="card-header">
        <h1>Статистика посещаемости</h1>
        <p class="card-subtitle">
            Анализ посещаемости по дням, классам и ученикам за выбранный месяц.
        </p>

        <div class="filters-layout">
            <form method="get" class="month-form">
                <label>
                    Месяц:
                    <input type="number" name="month" min="1" max="12" value="{{ month }}" class="input input-small">
                </label>
                <label>
                    Год:
                    <input type="number" name="year" min="2000" max="2100" value="{{ year }}" class="input input-small">
                </label>
                <button type="submit" class="btn btn-primary btn-small">Показать</button>
            </form>

            <div class="filters-panel">
                <div class="filters-row">
                    <label>
                        Общий поиск по тексту:
                        <input id="global-search"
                               type="text"
                               class="input"
                               placeholder="Класс, ФИО или любой текст">
                    </label>
                </div>

                <div class="filters-row filters-row-multi">
                    <label>
                        Фильтр по классу:
                        <input id="filter-class"
                               type="text"
                               class="input"
                               placeholder="Например: 1В, 2А">
                    </label>
                    <label>
                        Фильтр по ученику:
                        <input id="filter-student"
                               type="text"
                               class="input"
                               placeholder="ФИО или часть имени">
                    </label>
                </div>

                <div class="filters-row filters-row-multi">
                    <label>
                        Мин. неуважительных (день / класс):
                        <input id="filter-min-unexcused"
                               type="number"
                               min="0"
                               class="input input-small"
                               placeholder="0">
                    </label>
                    <label>
                        Мин. неявок ученика за месяц:
                        <input id="filter-min-absences"
                               type="number"
                               min="0"
                               class="input input-small"
                               placeholder="0">
                    </label>
                    <label>
                        Таблица:
                        <select id="filter-table-type" class="input">
                            <option value="all">Все</option>
                            <option value="daily">Дневная</option>
                            <option value="by_class">По классам</option>
                            <option value="by_student">По ученикам</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    {# === ДНЕВНАЯ СТАТИСТИКА === #}
    <div class="card-section" data-section-block="daily">
        <div class="section-header">
            <h2>Дневная статистика</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="daily-section-body">
                Развернуть
            </button>
        </div>

        <div id="daily-section-body" class="section-body collapsed">
            {% if ordered_days %}
                {% for day, records in ordered_days %}
                    <div class="subcard" data-section="daily" data-day="{{ day|date:'Y-m-d' }}">
                        <div class="subcard-header-line">
                            <div class="subcard-header-main">
                                <h3>{{ day|date:"d.m.Y" }}</h3>

                                {% with totals=day_totals|dict_get:day %}
                                    <div class="daily-summary">
                                        <span class="muted">Итого за день:</span>
                                        <span class="daily-summary-item">
                                            По списку:
                                            <span class="text-bold">
                                                {{ totals.total_present_auto|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Пришло по факту:
                                            <span class="text-bold">
                                                {{ totals.total_present_reported|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Неуважительные:
                                            <span class="text-bold">
                                                {{ totals.total_unexcused|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            ОРВИ:
                                            <span class="text-bold">
                                                {{ totals.total_orvi|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Другие заболевания:
                                            <span class="text-bold">
                                                {{ totals.total_other_disease|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            По семейным обстоятельствам:
                                            <span class="text-bold">
                                                {{ totals.total_family|default:"0" }}
                                            </span>
                                        </span>
                                    </div>
                                {% endwith %}
                            </div>

                            <button type="button"
                                    class="btn btn-small btn-outline collapse-toggle"
                                    data-target-id="day-body-{{ forloop.counter0 }}">
                                Развернуть
                            </button>
                        </div>

                        <div id="day-body-{{ forloop.counter0 }}" class="subcard-body collapsed">
                            <div class="table-wrapper">
                                <table class="table table-compact">
                                    <thead>
                                    <tr>
                                        <th>Класс</th>
                                        <th>Пришло по факту</th>

                                        <th>Неуважительные</th>
                                        <th>Ученики с неуважительной причиной</th>

                                        <th>ОРВИ</th>
                                        <th>Ученики с ОРВИ</th>

                                        <th>Другие заболевания</th>
                                        <th>Ученики с другими заболеваниями</th>

                                        <th>По семейным обстоятельствам</th>
                                        <th>Ученики по семейным обстоятельствам</th>

                                        <th>Все отсутствующие ученики</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for s in records %}
                                        <tr data-row-type="daily"
                                            data-class-name="{{ s.class_room.name|lower }}"
                                            data-unexcused="{{ s.unexcused_absent_count }}">
                                            <td>{{ s.class_room.name }}</td>
                                            <td>{{ s.present_count_reported }}</td>

                                            <td>{{ s.unexcused_absent_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'unexcused' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.orvi_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'orvi' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.other_disease_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'other_disease' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.family_reason_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'family' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            <li class="pill">{{ a.student.full_name }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="muted">За выбранный месяц данных нет.</p>
            {% endif %}
        </div>
    </div>

    {# === СВОДКА ПО КЛАССАМ ЗА МЕСЯЦ === #}
    <div class="card-section" data-section-block="by_class">
        <div class="section-header">
            <h2>Сводка по классам за месяц</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="by-class-section-body">
                Развернуть
            </button>
        </div>

        <div id="by-class-section-body" class="section-body collapsed">
            {% if monthly_by_class %}
                <div class="table-wrapper">
                    <table class="table table-compact">
                        <thead>
                        <tr>
                            <th>Класс</th>
                            <th>Всего пришедших</th>
                            <th>Всего неуважительных</th>
                            <th>ОРВИ</th>
                            <th>Другие заболевания</th>
                            <th>По семейным обстоятельствам</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in monthly_by_class %}
                            <tr data-row-type="by_class"
                                data-class-name="{{ row.class_room__name|lower }}"
                                data-total-unexcused="{{ row.total_unexcused|default:0 }}">
                                <td>{{ row.class_room__name }}</td>
                                <td>{{ row.total_present_reported|default:"0" }}</td>
                                <td>{{ row.total_unexcused|default:"0" }}</td>
                                <td>{{ row.total_orvi|default:"0" }}</td>
                                <td>{{ row.total_other_disease|default:"0" }}</td>
                                <td>{{ row.total_family|default:"0" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="muted">Нет данных для построения сводной таблицы.</p>
            {% endif %}
        </div>
    </div>

    {# === СТАТИСТИКА ПО УЧЕНИКАМ === #}
    <div class="card-section" data-section-block="by_student">
        <div class="section-header">
            <h2>Статистика по ученикам за месяц (неуважительные)</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="by-student-section-body">
                Развернуть
            </button>
        </div>

        <div id="by-student-section-body" class="section-body collapsed">
            {% if per_student %}
                <div class="table-wrapper">
                    <table class="table table-compact">
                        <thead>
                        <tr>
                            <th>Класс</th>
                            <th>ФИО ученика</th>
                            <th>Кол-во неявок</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in per_student %}
                            <tr data-row-type="by_student"
                                data-class-name="{{ row.student__class_room__name|lower }}"
                                data-student-name="{{ row.student__full_name|lower }}"
                                data-absence-count="{{ row.absence_count }}">
                                <td>{{ row.student__class_room__name }}</td>
                                <td>{{ row.student__full_name }}</td>
                                <td>{{ row.absence_count }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="muted">Нет данных по отсутствиям учеников за выбранный месяц.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // сворачивание/разворачивание блоков
    (function () {
        document.querySelectorAll('.collapse-toggle').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const targetId = this.dataset.targetId;
                const target = document.getElementById(targetId);
                if (!target) return;
                const collapsed = target.classList.toggle('collapsed');
                this.textContent = collapsed ? 'Развернуть' : 'Свернуть';
            });
        });
    })();

    function textMatches(el, needle) {
        if (!needle) return true;
        const txt = (el.textContent || '').toLowerCase();
        return txt.includes(needle.toLowerCase());
    }

    (function () {
        const globalInput = document.getElementById('global-search');
        const classInput = document.getElementById('filter-class');
        const studentInput = document.getElementById('filter-student');
        const minUnexcusedInput = document.getElementById('filter-min-unexcused');
        const minAbsencesInput = document.getElementById('filter-min-absences');
        const typeSelect = document.getElementById('filter-table-type');

        function applyFilters() {
            const globalTerm = globalInput.value.trim().toLowerCase();
            const classTerm = classInput.value.trim().toLowerCase();
            const studentTerm = studentInput.value.trim().toLowerCase();
            const minUnexcused = parseInt(minUnexcusedInput.value || '0', 10) || 0;
            const minAbsences = parseInt(minAbsencesInput.value || '0', 10) || 0;
            const tableType = typeSelect.value;

            // управление видимостью секций
            document.querySelectorAll('[data-section-block]').forEach(function (block) {
                const kind = block.dataset.sectionBlock;
                block.style.display =
                    (tableType === 'all' || tableType === kind) ? '' : 'none';
            });

            // все строки во всех таблицах
            document.querySelectorAll('tr[data-row-type]').forEach(function (row) {
                const rowType = row.dataset.rowType;
                const className = (row.dataset.className || '').toLowerCase();
                const studentName = (row.dataset.studentName || '').toLowerCase();
                const unexcused = parseInt(row.dataset.unexcused || row.dataset.totalUnexcused || '0', 10) || 0;
                const absenceCount = parseInt(row.dataset.absenceCount || '0', 10) || 0;

                let visible = true;

                // фильтр по типу таблицы
                if (tableType !== 'all') {
                    if (tableType === 'daily' && rowType !== 'daily') visible = false;
                    if (tableType === 'by_class' && rowType !== 'by_class') visible = false;
                    if (tableType === 'by_student' && rowType !== 'by_student') visible = false;
                }

                if (globalTerm && !textMatches(row, globalTerm)) {
                    visible = false;
                }

                if (classTerm && !className.includes(classTerm)) {
                    visible = false;
                }

                if (studentTerm) {
                    if (rowType === 'by_student') {
                        if (!studentName.includes(studentTerm)) {
                            visible = false;
                        }
                    } else if (!textMatches(row, studentTerm)) {
                        visible = false;
                    }
                }

                if (minUnexcused > 0 &&
                    (rowType === 'daily' || rowType === 'by_class')) {
                    if (unexcused < minUnexcused) {
                        visible = false;
                    }
                }

                if (minAbsences > 0 && rowType === 'by_student') {
                    if (absenceCount < minAbsences) {
                        visible = false;
                    }
                }

                row.style.display = visible ? '' : 'none';
            });
        }

        [globalInput, classInput, studentInput, minUnexcusedInput, minAbsencesInput, typeSelect]
            .forEach(function (el) {
                if (!el) return;
                el.addEventListener('input', applyFilters);
                el.addEventListener('change', applyFilters);
            });

        applyFilters();
    })();
</script>
{% endblock %}