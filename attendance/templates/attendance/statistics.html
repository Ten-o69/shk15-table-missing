{% extends 'attendance/base.html' %}
{% load static %}
{% load attendance_tags %}

{% block title %}Статистика посещаемости{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'attendance/css/statistics.css' %}">
{% endblock %}

{% block content %}
<div class="card page-wide shadow-sm">
  <div class="card-body p-3 p-lg-4">

    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h4 mb-1">Статистика посещаемости</h1>
        <p class="text-secondary mb-0">
          Анализ посещаемости по дням, классам и ученикам за выбранный месяц.
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-light btn-sm d-xl-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#advanced-filters"
                aria-expanded="false"
                aria-controls="advanced-filters">
          <i class="bi bi-sliders me-1"></i> Фильтры
        </button>
      </div>
    </div>

    <div class="app-panel p-3 p-lg-3 mb-4">
      <div class="row g-3 align-items-end">

        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label mb-1" for="stat-month">Месяц</label>
          <input id="stat-month"
                 type="number"
                 name="month"
                 min="1"
                 max="12"
                 value="{{ month }}"
                 class="form-control form-control-sm"
                 inputmode="numeric"
                 form="month-form">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label mb-1" for="stat-year">Год</label>
          <input id="stat-year"
                 type="number"
                 name="year"
                 min="2000"
                 max="2100"
                 value="{{ year }}"
                 class="form-control form-control-sm"
                 inputmode="numeric"
                 form="month-form">
        </div>

        <div class="col-12 col-md-3 col-xl-2">
          <form method="get" id="month-form" class="d-flex">
            <button type="submit" class="btn btn-primary w-100 btn-sm">
              <i class="bi bi-search me-1"></i> Показать
            </button>
          </form>
        </div>

        <div class="col-12 col-xl-6">
          <label class="form-label mb-1" for="global-search">
            <i class="bi bi-funnel me-1"></i> Общий поиск
          </label>
          <div class="input-group">
            <span class="input-group-text bg-transparent text-secondary border-0 ps-0">
              <i class="bi bi-search"></i>
            </span>
            <input id="global-search"
                   type="text"
                   class="form-control"
                   placeholder="Класс, ФИО или любой текст"
                   autocomplete="off">
          </div>
          <div class="form-text">Фильтры работают без перезагрузки.</div>
        </div>

      </div>

      <div class="collapse d-xl-block mt-3" id="advanced-filters">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-6 col-xl-3">
            <label class="form-label mb-1" for="filter-class">Класс</label>
            <input id="filter-class" type="text" class="form-control" placeholder="Например: 1В, 2А" autocomplete="off">
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <label class="form-label mb-1" for="filter-student">Ученик</label>
            <input id="filter-student" type="text" class="form-control" placeholder="ФИО или часть имени" autocomplete="off">
          </div>
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-min-unexcused">Мин. неуважительных</label>
            <input id="filter-min-unexcused" type="number" min="0" class="form-control form-control-sm" placeholder="0" inputmode="numeric">
          </div>
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-min-absences">Мин. неявок ученика</label>
            <input id="filter-min-absences" type="number" min="0" class="form-control form-control-sm" placeholder="0" inputmode="numeric">
          </div>
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-table-type">Таблица</label>
            <select id="filter-table-type" class="form-select form-select-sm">
              <option value="all">Все</option>
              <option value="visuals">Визуализация</option>
              <option value="privileged_types">Льготники по типам</option>
              <option value="daily">Дневная</option>
              <option value="by_class">По классам</option>
              <option value="by_student">По ученикам</option>
            </select>
            <div class="btn-group btn-group-sm w-100 mt-2" role="group">
              <button type="button" class="btn btn-outline-light" data-table-type-btn="all">Все</button>
              <button type="button" class="btn btn-outline-light" data-table-type-btn="visuals">Графики</button>
              <button type="button" class="btn btn-outline-light" data-table-type-btn="by_class">Классы</button>
            </div>
          </div>
          <div class="col-12 col-xl-3 d-flex align-items-end">
            <button type="button" id="reset-filters" class="btn btn-outline-light w-100">
              <i class="bi bi-arrow-counterclockwise me-1"></i> Сбросить фильтры
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card-section" data-section-block="visuals">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-visuals"
              aria-expanded="false"
              aria-controls="sec-visuals"
              data-section-toggle-btn="visuals">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-grid-3x3-gap me-1 text-info"></i> Визуализация за месяц
          </h2>
          <span class="text-secondary small">Карта посещаемости и тренды</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-visuals" data-section-collapse="visuals">
        <div class="pt-3">
           <div class="d-flex flex-wrap align-items-center justify-content-end gap-3 mb-3">
              <div class="d-flex align-items-center gap-1">
                  <span class="d-inline-block rounded-1" style="width: 12px; height: 12px; background-color: #343a40; border: 1px solid #555;"></span>
                  <span class="text-secondary small">Нет отчета</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                  <span class="d-inline-block rounded-1" style="width: 12px; height: 12px; background-color: #dc3545;"></span>
                  <span class="text-secondary small">&lt; 85%</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                  <span class="d-inline-block rounded-1" style="width: 12px; height: 12px; background-color: #ffc107;"></span>
                  <span class="text-secondary small">85-94%</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                  <span class="d-inline-block rounded-1" style="width: 12px; height: 12px; background-color: #198754;"></span>
                  <span class="text-secondary small">&ge; 95%</span>
              </div>
          </div>

          <div class="row g-4">
              <div class="col-12">
                  <div class="app-panel p-3">
                      <div class="text-secondary small mb-2">Общая динамика посещаемости школы (%)</div>
                      <div id="chart-timeline" style="min-height: 180px;"></div>
                  </div>
              </div>

              <div class="col-12">
                  <div class="app-panel p-3">
                      <div class="text-secondary small mb-2">Детализация по классам (наведите на ячейку)</div>
                      <div id="chart-heatmap" style="min-height: 400px;"></div>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-section" data-section-block="privileged_types">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-privileged_types"
              aria-expanded="false"
              aria-controls="sec-privileged_types"
              data-section-toggle-btn="privileged_types">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-star-fill text-warning me-1"></i> Льготники по типам
          </h2>
          <span class="text-secondary small">Свод по классам</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-privileged_types" data-section-collapse="privileged_types">
        {% if privileged_types_by_class %}
          <div class="app-table mt-2" data-app-table>
            <div class="app-table__toolbar">
              <div class="app-table__toolbar-actions ms-auto">
                <button type="button" class="btn btn-outline-light btn-sm" data-table-copy>
                  <i class="bi bi-clipboard me-1"></i> Скопировать
                </button>
                <span class="app-table__copy-status" data-copy-status></span>
              </div>
            </div>
            <div class="table-responsive app-table__scroll">
              <table class="table table-dark table-hover table-sm align-middle mb-0 app-table__table app-table--stack"
                     data-app-table-target
                     data-sort-columns="class,number,number,number,number,number">
              <thead>
                <tr>
                  <th class="text-nowrap">Класс</th>
                  <th class="text-nowrap">СВО</th>
                  <th class="text-nowrap">Многодетные</th>
                  <th class="text-nowrap">Малоимущие</th>
                  <th class="text-nowrap">ОВЗ</th>
                  <th class="text-nowrap">Итого</th>
                </tr>
              </thead>
              <tbody>
                {% for r in privileged_types_by_class %}
                  <tr data-row-type="privileged_types" data-class-name="{{ r.class_name|lower }}">
                    <td class="fw-semibold stack-head-cell" data-label="Класс">{{ r.class_name }}</td>
                    <td data-label="СВО">{{ r.svo }}</td>
                    <td data-label="Многодетные">{{ r.multi }}</td>
                    <td data-label="Малоимущие">{{ r.low_income }}</td>
                    <td data-label="ОВЗ">{{ r.disabled }}</td>
                    <td class="fw-semibold" data-label="Итого">{{ r.total }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-footer">
                <tr>
                  <td class="fw-semibold stack-head-cell" data-label="Класс">Итого</td>
                  <td data-label="СВО">{{ privileged_types_totals.svo }}</td>
                  <td data-label="Многодетные">{{ privileged_types_totals.multi }}</td>
                  <td data-label="Малоимущие">{{ privileged_types_totals.low_income }}</td>
                  <td data-label="ОВЗ">{{ privileged_types_totals.disabled }}</td>
                  <td class="fw-semibold" data-label="Итого">{{ privileged_types_totals.total }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">Нет данных.</div>
        {% endif %}
      </div>
    </div>

    <div class="card-section" data-section-block="daily">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-daily"
              aria-expanded="false"
              aria-controls="sec-daily"
              data-section-toggle-btn="daily">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-calendar3 me-1"></i> Дневная статистика
          </h2>
          <span class="text-secondary small">Нажмите на дату, чтобы раскрыть детали</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-daily" data-section-collapse="daily">
        {% if ordered_days %}
          <div class="accordion accordion-flush mt-2" id="days-accordion">
            {% for day, records in ordered_days %}
              <div class="accordion-item app-accordion-item">
                <h3 class="accordion-header" id="day-heading-{{ forloop.counter0 }}">
                  <button class="accordion-button collapsed app-accordion-btn"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#day-body-{{ forloop.counter0 }}"
                          aria-expanded="false"
                          aria-controls="day-body-{{ forloop.counter0 }}">
                    <span class="me-2 fw-semibold">{{ day|date:"d.m.Y" }}</span>

                    {% with totals=day_totals|dict_get:day reported=day_reported_counts|dict_get:day %}
                      <span class="daily-ratio-badge me-2">
                        Отметили: <span class="daily-ratio-value">{{ reported|default:"0" }}/{{ total_classes_count }}</span>
                      </span>

                      <span class="text-secondary small ms-auto d-none d-md-inline">
                        По списку: {{ total_students_count|default:"0" }} •
                        Пришло: {{ totals.total_present_reported|default:"0" }} •
                        Неув.: {{ totals.total_unexcused|default:"0" }} •
                        ОРВИ: {{ totals.total_orvi|default:"0" }}
                      </span>

                      <span class="ms-auto d-md-none">
                        <span class="badge text-bg-secondary-subtle me-1">
                          Пришло: {{ totals.total_present_reported|default:"0" }}
                        </span>
                      </span>
                    {% endwith %}
                  </button>
                </h3>

                <div id="day-body-{{ forloop.counter0 }}"
                     class="accordion-collapse collapse"
                     aria-labelledby="day-heading-{{ forloop.counter0 }}"
                     data-bs-parent="#days-accordion">
                  <div class="accordion-body pt-2">

                    {% with totals=day_totals|dict_get:day %}
                      <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center justify-content-between gap-2 mb-2">
                        <div class="summary-mini mb-0">
                          <span class="muted">Итого за день:</span>
                          <span class="summary-mini-item">По списку: <b>{{ total_students_count|default:"0" }}</b></span>
                          <span class="summary-mini-item">Пришло: <b>{{ totals.total_present_reported|default:"0" }}</b></span>
                          <span class="summary-mini-item">Неув.: <b>{{ totals.total_unexcused|default:"0" }}</b></span>
                          <span class="summary-mini-item">ОРВИ: <b>{{ totals.total_orvi|default:"0" }}</b></span>
                          <span class="summary-mini-item">Другие: <b>{{ totals.total_other_disease|default:"0" }}</b></span>
                          <span class="summary-mini-item">Семейные: <b>{{ totals.total_family|default:"0" }}</b></span>
                        </div>

                        <button type="button"
                                class="btn btn-outline-info btn-sm js-export-day"
                                data-bs-toggle="modal"
                                data-bs-target="#export-day-modal-{{ forloop.counter0 }}">
                          <i class="bi bi-download me-1"></i> Выгрузить
                        </button>
                      </div>
                    {% endwith %}

                    <div class="modal fade" id="export-day-modal-{{ forloop.counter0 }}" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered modal-sm">
                        <div class="modal-content bg-dark border border-secondary-subtle">
                          <div class="modal-header">
                            <h2 class="h6 mb-0">Выгрузка {{ day|date:"d.m.Y" }}</h2>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <form method="get" action="{% url 'daily_statistics_export' %}">
                            <div class="modal-body">
                              <input type="hidden" name="date" value="{{ day|date:'Y-m-d' }}">
                              <div class="vstack gap-2">
                                <label class="export-format-row"><input type="radio" name="format" value="excel" checked> <span>Excel</span></label>
                                <label class="export-format-row"><input type="radio" name="format" value="word"> <span>Word</span></label>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="submit" class="btn btn-primary w-100">Скачать</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <div class="app-table" data-app-table>
                      <div class="app-table__toolbar">
                        <div class="app-table__toolbar-actions ms-auto">
                           <button type="button" class="btn btn-outline-light btn-sm" data-table-copy><i class="bi bi-clipboard"></i></button>
                           <span class="app-table__copy-status" data-copy-status></span>
                        </div>
                      </div>
                      <div class="table-responsive app-table__scroll">
                        <table class="table table-dark table-hover table-sm align-middle mb-0 app-table__table app-table--stack"
                               data-app-table-target
                               data-sort-columns="class,number,number,none,number,none,number,none,number,none,none">
                        <thead>
                          <tr>
                            <th>Класс</th>
                            <th>Пришло</th>
                            <th>Неув.</th>
                            <th>Ученики (неув.)</th>
                            <th>ОРВИ</th>
                            <th>Ученики (ОРВИ)</th>
                            <th>Другие</th>
                            <th>Ученики (другие)</th>
                            <th>Семейные</th>
                            <th>Ученики (сем.)</th>
                            <th>Все</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for s in records %}
                            <tr data-row-type="daily" data-class-name="{{ s.class_room.name|lower }}" data-unexcused="{{ s.unexcused_absent_count }}">
                              <td class="fw-semibold stack-head-cell" data-label="Класс">{{ s.class_room.name }}</td>
                              <td data-label="Пришло">{{ s.present_count_reported }}</td>
                              <td data-label="Неув.">{{ s.unexcused_absent_count }}</td>
                              <td data-label="Ученики (неув.)">
                                {% for a in s.absent_students.all %}{% if a.reason == 'unexcused' %}{{ a.student.full_name }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}
                              </td>
                              <td data-label="ОРВИ">{{ s.orvi_count }}</td>
                              <td data-label="Ученики (ОРВИ)">
                                {% for a in s.absent_students.all %}{% if a.reason == 'orvi' %}{{ a.student.full_name }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}
                              </td>
                              <td data-label="Другие">{{ s.other_disease_count }}</td>
                              <td data-label="Ученики (другие)">
                                {% for a in s.absent_students.all %}{% if a.reason == 'other_disease' %}{{ a.student.full_name }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}
                              </td>
                              <td data-label="Семейные">{{ s.family_reason_count }}</td>
                              <td data-label="Ученики (сем.)">
                                {% for a in s.absent_students.all %}{% if a.reason == 'family' %}{{ a.student.full_name }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}
                              </td>
                              <td data-label="Все">
                                {% for a in s.absent_students.all %}{{ a.student.full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">Нет данных.</div>
        {% endif %}
      </div>
    </div>

    <div class="card-section" data-section-block="by_class">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-by_class"
              aria-expanded="false"
              aria-controls="sec-by_class"
              data-section-toggle-btn="by_class">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0"><i class="bi bi-bar-chart-line me-1"></i> Сводка по классам</h2>
          <span class="text-secondary small">Суммарно за месяц</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-by_class" data-section-collapse="by_class">
        {% if monthly_by_class %}
          <div class="app-table mt-2" data-app-table>
            <div class="app-table__toolbar">
              <div class="app-table__toolbar-actions ms-auto">
                <button type="button" class="btn btn-outline-light btn-sm" data-table-copy><i class="bi bi-clipboard"></i></button>
                <span class="app-table__copy-status" data-copy-status></span>
              </div>
            </div>
            <div class="table-responsive app-table__scroll">
              <table class="table table-dark table-hover table-sm align-middle mb-0 app-table__table app-table--stack"
                     data-app-table-target
                     data-sort-columns="class,number,number,number,number,number">
              <thead>
                <tr>
                  <th>Класс</th>
                  <th>Всего пришедших</th>
                  <th>Всего неув.</th>
                  <th>ОРВИ</th>
                  <th>Другие</th>
                  <th>Семейные</th>
                </tr>
              </thead>
              <tbody>
                {% for row in monthly_by_class %}
                  <tr data-row-type="by_class" data-class-name="{{ row.class_room__name|lower }}" data-total-unexcused="{{ row.total_unexcused|default:0 }}">
                    <td class="fw-semibold stack-head-cell" data-label="Класс">{{ row.class_room__name }}</td>
                    <td data-label="Всего пришедших">{{ row.total_present_reported|default:"0" }}</td>
                    <td data-label="Всего неув.">{{ row.total_unexcused|default:"0" }}</td>
                    <td data-label="ОРВИ">{{ row.total_orvi|default:"0" }}</td>
                    <td data-label="Другие">{{ row.total_other_disease|default:"0" }}</td>
                    <td data-label="Семейные">{{ row.total_family|default:"0" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">Нет данных.</div>
        {% endif %}
      </div>
    </div>

    <div class="card-section" data-section-block="by_student">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-by_student"
              aria-expanded="false"
              aria-controls="sec-by_student"
              data-section-toggle-btn="by_student">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0"><i class="bi bi-people me-1"></i> Статистика по ученикам</h2>
          <span class="text-secondary small">Неуважительные пропуски</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-by_student" data-section-collapse="by_student">
        {% if per_student %}
          <div class="app-table mt-2" data-app-table>
            <div class="app-table__toolbar">
              <div class="app-table__toolbar-actions ms-auto">
                 <button type="button" class="btn btn-outline-light btn-sm" data-table-copy><i class="bi bi-clipboard"></i></button>
                 <span class="app-table__copy-status" data-copy-status></span>
              </div>
            </div>
            <div class="table-responsive app-table__scroll">
              <table class="table table-dark table-hover table-sm align-middle mb-0 app-table__table app-table--stack"
                     data-app-table-target
                     data-sort-columns="class,text,number">
              <thead>
                <tr>
                  <th>Класс</th>
                  <th>ФИО ученика</th>
                  <th>Кол-во неявок</th>
                </tr>
              </thead>
              <tbody>
                {% for row in per_student %}
                  <tr data-row-type="by_student" data-class-name="{{ row.student__class_room__name|lower }}" data-student-name="{{ row.student__full_name|lower }}" data-absence-count="{{ row.absence_count }}">
                    <td class="fw-semibold stack-head-cell" data-label="Класс">{{ row.student__class_room__name }}</td>
                    <td data-label="Ученик">{{ row.student__full_name }}</td>
                    <td data-label="Кол-во неявок">{{ row.absence_count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">Нет данных.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block script %}
<script>
    window.APP_CHART_DATA = {{ chart_data_json|safe }};
</script>

<script src="{% static 'attendance/js/libs/apexcharts.min.js' %}"></script>
<script src="{% static 'attendance/js/statistics.js' %}"></script>
{% endblock %}