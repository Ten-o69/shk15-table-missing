{% extends 'attendance/base.html' %}
{% load static %}
{% load attendance_tags %}

{% block title %}Статистика посещаемости{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'attendance/css/statistics.css' %}">
{% endblock %}

{% block content %}
<div class="card page-wide shadow-sm">
  <div class="card-body p-3 p-lg-4">

    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h4 mb-1">Статистика посещаемости</h1>
        <p class="text-secondary mb-0">
          Анализ посещаемости по дням, классам и ученикам за выбранный месяц.
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-light btn-sm d-xl-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#advanced-filters"
                aria-expanded="false"
                aria-controls="advanced-filters">
          <i class="bi bi-sliders me-1"></i> Фильтры
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="app-panel p-3 p-lg-3 mb-4">
      <div class="row g-3 align-items-end">

        <!-- Month / Year / Submit (GET form) -->
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label mb-1" for="stat-month">Месяц</label>
          <input id="stat-month"
                 type="number"
                 name="month"
                 min="1"
                 max="12"
                 value="{{ month }}"
                 class="form-control form-control-sm"
                 inputmode="numeric"
                 form="month-form">
        </div>

        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label mb-1" for="stat-year">Год</label>
          <input id="stat-year"
                 type="number"
                 name="year"
                 min="2000"
                 max="2100"
                 value="{{ year }}"
                 class="form-control form-control-sm"
                 inputmode="numeric"
                 form="month-form">
        </div>

        <div class="col-12 col-md-3 col-xl-2">
          <form method="get" id="month-form" class="d-flex">
            {# поля month/year связаны через form="month-form" #}
            <button type="submit" class="btn btn-primary w-100 btn-sm">
              <i class="bi bi-search me-1"></i> Показать
            </button>
          </form>
        </div>

        <!-- Global search (always visible) -->
        <div class="col-12 col-xl-6">
          <label class="form-label mb-1" for="global-search">
            <i class="bi bi-funnel me-1"></i> Общий поиск
          </label>
          <div class="input-group">
            <span class="input-group-text bg-transparent text-secondary border-0 ps-0">
              <i class="bi bi-search"></i>
            </span>
            <input id="global-search"
                   type="text"
                   class="form-control"
                   placeholder="Класс, ФИО или любой текст"
                   autocomplete="off">
          </div>
          <div class="form-text">Фильтры работают без перезагрузки.</div>
        </div>

      </div>

      <!-- Advanced filters (collapsed on smaller screens via button) -->
      <div class="collapse d-xl-block mt-3" id="advanced-filters">
        <div class="row g-3 align-items-end">

          <!-- Class / Student -->
          <div class="col-12 col-md-6 col-xl-3">
            <label class="form-label mb-1" for="filter-class">Класс</label>
            <input id="filter-class"
                   type="text"
                   class="form-control"
                   placeholder="Например: 1В, 2А"
                   autocomplete="off">
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <label class="form-label mb-1" for="filter-student">Ученик</label>
            <input id="filter-student"
                   type="text"
                   class="form-control"
                   placeholder="ФИО или часть имени"
                   autocomplete="off">
          </div>

          <!-- Min values -->
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-min-unexcused">Мин. неуважительных</label>
            <input id="filter-min-unexcused"
                   type="number"
                   min="0"
                   class="form-control form-control-sm"
                   placeholder="0"
                   inputmode="numeric">
            <div class="form-text">Для «Дневная» и «По классам».</div>
          </div>

          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-min-absences">Мин. неявок ученика</label>
            <input id="filter-min-absences"
                   type="number"
                   min="0"
                   class="form-control form-control-sm"
                   placeholder="0"
                   inputmode="numeric">
            <div class="form-text">Только для таблицы «По ученикам».</div>
          </div>

          <!-- Table type -->
          <div class="col-12 col-md-4 col-xl-3">
            <label class="form-label mb-1" for="filter-table-type">Таблица</label>
            <select id="filter-table-type" class="form-select form-select-sm">
              <option value="all">Все</option>
              <option value="privileged_types">Льготники по типам</option>
              <option value="daily">Дневная</option>
              <option value="by_class">По классам</option>
              <option value="by_student">По ученикам</option>
            </select>

            <!-- Optional quick switch (UI only, syncs select via JS) -->
            <div class="btn-group btn-group-sm w-100 mt-2" role="group" aria-label="Быстрый выбор таблицы">
              <button type="button" class="btn btn-outline-light" data-table-type-btn="all">Все</button>
              <button type="button" class="btn btn-outline-light" data-table-type-btn="daily">Дни</button>
              <button type="button" class="btn btn-outline-light" data-table-type-btn="by_class">Классы</button>
              <button type="button" class="btn btn-outline-light" data-table-type-btn="by_student">Ученики</button>
            </div>
          </div>

          <!-- Reset -->
          <div class="col-12 col-xl-3 d-flex align-items-end">
            <button type="button" id="reset-filters" class="btn btn-outline-light w-100">
              <i class="bi bi-arrow-counterclockwise me-1"></i> Сбросить фильтры
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- === ЛЬГОТНИКИ ПО ТИПАМ === -->
    <div class="card-section" data-section-block="privileged_types">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-privileged_types"
              aria-expanded="false"
              aria-controls="sec-privileged_types"
              data-section-toggle-btn="privileged_types">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-star-fill text-warning me-1"></i> Льготники по типам (по классам)
          </h2>
          <span class="text-secondary small">Свод по классам за выбранный месяц</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-privileged_types" data-section-collapse="privileged_types">
        {% if privileged_types_by_class %}
          <div class="table-responsive app-table-responsive mt-2">
            <table class="table table-dark table-hover table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap">Класс</th>
                  <th class="text-nowrap">СВО</th>
                  <th class="text-nowrap">Многодетные</th>
                  <th class="text-nowrap">Малоимущие</th>
                  <th class="text-nowrap">Инвалиды</th>
                  <th class="text-nowrap">Итого</th>
                </tr>
              </thead>
              <tbody>
                {% for r in privileged_types_by_class %}
                  <tr data-row-type="privileged_types" data-class-name="{{ r.class_name|lower }}">
                    <td class="fw-semibold">{{ r.class_name }}</td>
                    <td>{{ r.svo }}</td>
                    <td>{{ r.multi }}</td>
                    <td>{{ r.low_income }}</td>
                    <td>{{ r.disabled }}</td>
                    <td class="fw-semibold">{{ r.total }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-footer">
                <tr>
                  <td class="fw-semibold">Итого</td>
                  <td>{{ privileged_types_totals.svo }}</td>
                  <td>{{ privileged_types_totals.multi }}</td>
                  <td>{{ privileged_types_totals.low_income }}</td>
                  <td>{{ privileged_types_totals.disabled }}</td>
                  <td class="fw-semibold">{{ privileged_types_totals.total }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">
            Нет льготников с указанным типом.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- === ДНЕВНАЯ СТАТИСТИКА === -->
    <div class="card-section" data-section-block="daily">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-daily"
              aria-expanded="false"
              aria-controls="sec-daily"
              data-section-toggle-btn="daily">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-calendar3 me-1"></i> Дневная статистика
          </h2>
          <span class="text-secondary small">Нажмите на дату, чтобы раскрыть детали</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-daily" data-section-collapse="daily">
        {% if ordered_days %}
          <div class="accordion accordion-flush mt-2" id="days-accordion">
            {% for day, records in ordered_days %}
              <div class="accordion-item app-accordion-item">
                <h3 class="accordion-header" id="day-heading-{{ forloop.counter0 }}">
                  <button class="accordion-button collapsed app-accordion-btn"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#day-body-{{ forloop.counter0 }}"
                          aria-expanded="false"
                          aria-controls="day-body-{{ forloop.counter0 }}">
                    <span class="me-2 fw-semibold">{{ day|date:"d.m.Y" }}</span>

                    {% with totals=day_totals|dict_get:day %}
                      <span class="text-secondary small ms-auto d-none d-md-inline">
                        По списку: {{ totals.total_present_auto|default:"0" }} •
                        Пришло: {{ totals.total_present_reported|default:"0" }} •
                        Неув.: {{ totals.total_unexcused|default:"0" }} •
                        ОРВИ: {{ totals.total_orvi|default:"0" }}
                      </span>

                      <span class="ms-auto d-md-none">
                        <span class="badge text-bg-secondary-subtle me-1">Пришло: {{ totals.total_present_reported|default:"0" }}</span>
                        <span class="badge text-bg-secondary-subtle">Неув.: {{ totals.total_unexcused|default:"0" }}</span>
                      </span>
                    {% endwith %}
                  </button>
                </h3>

                <div id="day-body-{{ forloop.counter0 }}"
                     class="accordion-collapse collapse"
                     aria-labelledby="day-heading-{{ forloop.counter0 }}"
                     data-bs-parent="#days-accordion">
                  <div class="accordion-body pt-2">

                    {% with totals=day_totals|dict_get:day %}
                      <div class="summary-mini mb-2">
                        <span class="muted">Итого за день:</span>
                        <span class="summary-mini-item">По списку: <b>{{ totals.total_present_auto|default:"0" }}</b></span>
                        <span class="summary-mini-item">Пришло: <b>{{ totals.total_present_reported|default:"0" }}</b></span>
                        <span class="summary-mini-item">Неув.: <b>{{ totals.total_unexcused|default:"0" }}</b></span>
                        <span class="summary-mini-item">ОРВИ: <b>{{ totals.total_orvi|default:"0" }}</b></span>
                        <span class="summary-mini-item">Другие: <b>{{ totals.total_other_disease|default:"0" }}</b></span>
                        <span class="summary-mini-item">Семейные: <b>{{ totals.total_family|default:"0" }}</b></span>
                      </div>
                    {% endwith %}

                    <div class="table-responsive app-table-responsive">
                      <table class="table table-dark table-hover table-sm align-middle mb-0">
                        <thead>
                          <tr>
                            <th class="text-nowrap">Класс</th>
                            <th class="text-nowrap">Пришло</th>

                            <th class="text-nowrap">Неув.</th>
                            <th>Ученики (неув.)</th>

                            <th class="text-nowrap">ОРВИ</th>
                            <th>Ученики (ОРВИ)</th>

                            <th class="text-nowrap">Другие</th>
                            <th>Ученики (другие)</th>

                            <th class="text-nowrap">Семейные</th>
                            <th>Ученики (сем.)</th>

                            <th>Все отсутствующие</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for s in records %}
                            <tr data-row-type="daily"
                                data-class-name="{{ s.class_room.name|lower }}"
                                data-unexcused="{{ s.unexcused_absent_count }}">
                              <td class="fw-semibold">{{ s.class_room.name }}</td>
                              <td>{{ s.present_count_reported }}</td>

                              <td>{{ s.unexcused_absent_count }}</td>
                              <td>
                                {% if s.absent_students.all %}
                                  <ul class="pill-list">
                                    {% for a in s.absent_students.all %}
                                      {% if a.reason == 'unexcused' %}
                                        <li class="pill">{{ a.student.full_name }}</li>
                                      {% endif %}
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="muted">Нет данных</span>
                                {% endif %}
                              </td>

                              <td>{{ s.orvi_count }}</td>
                              <td>
                                {% if s.absent_students.all %}
                                  <ul class="pill-list">
                                    {% for a in s.absent_students.all %}
                                      {% if a.reason == 'orvi' %}
                                        <li class="pill">{{ a.student.full_name }}</li>
                                      {% endif %}
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="muted">Нет данных</span>
                                {% endif %}
                              </td>

                              <td>{{ s.other_disease_count }}</td>
                              <td>
                                {% if s.absent_students.all %}
                                  <ul class="pill-list">
                                    {% for a in s.absent_students.all %}
                                      {% if a.reason == 'other_disease' %}
                                        <li class="pill">{{ a.student.full_name }}</li>
                                      {% endif %}
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="muted">Нет данных</span>
                                {% endif %}
                              </td>

                              <td>{{ s.family_reason_count }}</td>
                              <td>
                                {% if s.absent_students.all %}
                                  <ul class="pill-list">
                                    {% for a in s.absent_students.all %}
                                      {% if a.reason == 'family' %}
                                        <li class="pill">{{ a.student.full_name }}</li>
                                      {% endif %}
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="muted">Нет данных</span>
                                {% endif %}
                              </td>

                              <td>
                                {% if s.absent_students.all %}
                                  <ul class="pill-list">
                                    {% for a in s.absent_students.all %}
                                      <li class="pill">{{ a.student.full_name }}</li>
                                    {% endfor %}
                                  </ul>
                                {% else %}
                                  <span class="muted">Нет данных</span>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">
            За выбранный месяц данных нет.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- === СВОДКА ПО КЛАССАМ === -->
    <div class="card-section" data-section-block="by_class">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-by_class"
              aria-expanded="false"
              aria-controls="sec-by_class"
              data-section-toggle-btn="by_class">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-bar-chart-line me-1"></i> Сводка по классам за месяц
          </h2>
          <span class="text-secondary small">Суммарно по причинам отсутствия</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-by_class" data-section-collapse="by_class">
        {% if monthly_by_class %}
          <div class="table-responsive app-table-responsive mt-2">
            <table class="table table-dark table-hover table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap">Класс</th>
                  <th class="text-nowrap">Всего пришедших</th>
                  <th class="text-nowrap">Всего неув.</th>
                  <th class="text-nowrap">ОРВИ</th>
                  <th class="text-nowrap">Другие</th>
                  <th class="text-nowrap">Семейные</th>
                </tr>
              </thead>
              <tbody>
                {% for row in monthly_by_class %}
                  <tr data-row-type="by_class"
                      data-class-name="{{ row.class_room__name|lower }}"
                      data-total-unexcused="{{ row.total_unexcused|default:0 }}">
                    <td class="fw-semibold">{{ row.class_room__name }}</td>
                    <td>{{ row.total_present_reported|default:"0" }}</td>
                    <td>{{ row.total_unexcused|default:"0" }}</td>
                    <td>{{ row.total_orvi|default:"0" }}</td>
                    <td>{{ row.total_other_disease|default:"0" }}</td>
                    <td>{{ row.total_family|default:"0" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">
            Нет данных для построения сводной таблицы.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- === ПО УЧЕНИКАМ === -->
    <div class="card-section" data-section-block="by_student">
      <button class="section-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sec-by_student"
              aria-expanded="false"
              aria-controls="sec-by_student"
              data-section-toggle-btn="by_student">
        <div class="section-toggle__left">
          <h2 class="h5 mb-0">
            <i class="bi bi-people me-1"></i> Статистика по ученикам за месяц (неуважительные)
          </h2>
          <span class="text-secondary small">Сортировка/фильтр по ФИО и минимуму неявок</span>
        </div>
        <i class="bi bi-chevron-down section-toggle__chev"></i>
      </button>

      <div class="collapse" id="sec-by_student" data-section-collapse="by_student">
        {% if per_student %}
          <div class="table-responsive app-table-responsive mt-2">
            <table class="table table-dark table-hover table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap">Класс</th>
                  <th>ФИО ученика</th>
                  <th class="text-nowrap">Кол-во неявок</th>
                </tr>
              </thead>
              <tbody>
                {% for row in per_student %}
                  <tr data-row-type="by_student"
                      data-class-name="{{ row.student__class_room__name|lower }}"
                      data-student-name="{{ row.student__full_name|lower }}"
                      data-absence-count="{{ row.absence_count }}">
                    <td class="fw-semibold">{{ row.student__class_room__name }}</td>
                    <td>{{ row.student__full_name }}</td>
                    <td>{{ row.absence_count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2 mb-0" role="alert">
            Нет данных по отсутствиям учеников за выбранный месяц.
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<script src="{% static 'attendance/js/statistics.js' %}"></script>
{% endblock %}