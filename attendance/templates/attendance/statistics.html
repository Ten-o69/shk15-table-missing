{% extends 'attendance/base.html' %}
{% load static %}
{% load attendance_tags %}

{% block title %}Статистика посещаемости{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'attendance/css/statistics.css' %}">
{% endblock %}

{% block content %}
<div class="card page-wide">
    <div class="card-header">
        <h1>Статистика посещаемости</h1>
        <p class="card-subtitle">
            Анализ посещаемости по дням, классам и ученикам за выбранный месяц.
        </p>

        <div class="filters-layout">
            <form method="get" class="month-form">
                <label>
                    Месяц:
                    <input type="number" name="month" min="1" max="12" value="{{ month }}" class="input input-small">
                </label>
                <label>
                    Год:
                    <input type="number" name="year" min="2000" max="2100" value="{{ year }}" class="input input-small">
                </label>
                <button type="submit" class="btn btn-primary btn-small">Показать</button>
            </form>

            <div class="filters-panel">
                <div class="filters-row">
                    <label>
                        Общий поиск по тексту:
                        <input id="global-search"
                               type="text"
                               class="input"
                               placeholder="Класс, ФИО или любой текст">
                    </label>
                </div>

                <div class="filters-row filters-row-multi">
                    <label>
                        Фильтр по классу:
                        <input id="filter-class"
                               type="text"
                               class="input"
                               placeholder="Например: 1В, 2А">
                    </label>
                    <label>
                        Фильтр по ученику:
                        <input id="filter-student"
                               type="text"
                               class="input"
                               placeholder="ФИО или часть имени">
                    </label>
                </div>

                <div class="filters-row filters-row-multi">
                    <label>
                        Мин. неуважительных (день / класс):
                        <input id="filter-min-unexcused"
                               type="number"
                               min="0"
                               class="input input-small"
                               placeholder="0">
                    </label>
                    <label>
                        Мин. неявок ученика за месяц:
                        <input id="filter-min-absences"
                               type="number"
                               min="0"
                               class="input input-small"
                               placeholder="0">
                    </label>
                    <label>
                        Таблица:
                        <select id="filter-table-type" class="input">
                            <option value="all">Все</option>
                            <option value="daily">Дневная</option>
                            <option value="by_class">По классам</option>
                            <option value="by_student">По ученикам</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    {# === ЛЬГОТНИКИ ПО ТИПАМ === #}
    <div class="card-section" data-section-block="privileged_types">
      <div class="section-header">
        <h2>Льготники по типам (по классам)</h2>
        <button type="button"
                class="btn btn-small btn-outline collapse-toggle"
                data-target-id="priv-types-section-body">
          Развернуть
        </button>
      </div>

      <div id="priv-types-section-body" class="section-body collapsed">
        {% if privileged_types_by_class %}
          <div class="table-wrapper">
            <table class="table table-compact">
              <thead>
              <tr>
                <th>Класс</th>
                <th>СВО</th>
                <th>Многодетные</th>
                <th>Малоимущие</th>
                <th>Инвалиды</th>
                <th>Итого</th>
              </tr>
              </thead>
              <tbody>
              {% for r in privileged_types_by_class %}
                <tr data-row-type="privileged_types" data-class-name="{{ r.class_name|lower }}">
                  <td class="text-bold">{{ r.class_name }}</td>
                  <td>{{ r.svo }}</td>
                  <td>{{ r.multi }}</td>
                  <td>{{ r.low_income }}</td>
                  <td>{{ r.disabled }}</td>
                  <td class="text-bold">{{ r.total }}</td>
                </tr>
              {% endfor %}
              </tbody>
              <tfoot class="table-footer">
              <tr>
                <td>Итого</td>
                <td>{{ privileged_types_totals.svo }}</td>
                <td>{{ privileged_types_totals.multi }}</td>
                <td>{{ privileged_types_totals.low_income }}</td>
                <td>{{ privileged_types_totals.disabled }}</td>
                <td>{{ privileged_types_totals.total }}</td>
              </tr>
              </tfoot>
            </table>
          </div>
        {% else %}
          <p class="muted">Нет льготников с указанным типом.</p>
        {% endif %}
      </div>
    </div>

    {# === ДНЕВНАЯ СТАТИСТИКА === #}
    <div class="card-section" data-section-block="daily">
        <div class="section-header">
            <h2>Дневная статистика</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="daily-section-body">
                Развернуть
            </button>
        </div>

        <div id="daily-section-body" class="section-body collapsed">
            {% if ordered_days %}
                {% for day, records in ordered_days %}
                    <div class="subcard" data-section="daily" data-day="{{ day|date:'Y-m-d' }}">
                        <div class="subcard-header-line">
                            <div class="subcard-header-main">
                                <h3>{{ day|date:"d.m.Y" }}</h3>

                                {% with totals=day_totals|dict_get:day %}
                                    <div class="daily-summary">
                                        <span class="muted">Итого за день:</span>
                                        <span class="daily-summary-item">
                                            По списку:
                                            <span class="text-bold">
                                                {{ totals.total_present_auto|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Пришло по факту:
                                            <span class="text-bold">
                                                {{ totals.total_present_reported|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Неуважительные:
                                            <span class="text-bold">
                                                {{ totals.total_unexcused|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            ОРВИ:
                                            <span class="text-bold">
                                                {{ totals.total_orvi|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            Другие заболевания:
                                            <span class="text-bold">
                                                {{ totals.total_other_disease|default:"0" }}
                                            </span>
                                        </span>
                                        <span class="daily-summary-item">
                                            По семейным обстоятельствам:
                                            <span class="text-bold">
                                                {{ totals.total_family|default:"0" }}
                                            </span>
                                        </span>
                                    </div>
                                {% endwith %}
                            </div>

                            <button type="button"
                                    class="btn btn-small btn-outline collapse-toggle"
                                    data-target-id="day-body-{{ forloop.counter0 }}">
                                Развернуть
                            </button>
                        </div>

                        <div id="day-body-{{ forloop.counter0 }}" class="subcard-body collapsed">
                            <div class="table-wrapper">
                                <table class="table table-compact">
                                    <thead>
                                    <tr>
                                        <th>Класс</th>
                                        <th>Пришло по факту</th>

                                        <th>Неуважительные</th>
                                        <th>Ученики с неуважительной причиной</th>

                                        <th>ОРВИ</th>
                                        <th>Ученики с ОРВИ</th>

                                        <th>Другие заболевания</th>
                                        <th>Ученики с другими заболеваниями</th>

                                        <th>По семейным обстоятельствам</th>
                                        <th>Ученики по семейным обстоятельствам</th>

                                        <th>Все отсутствующие ученики</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for s in records %}
                                        <tr data-row-type="daily"
                                            data-class-name="{{ s.class_room.name|lower }}"
                                            data-unexcused="{{ s.unexcused_absent_count }}">
                                            <td>{{ s.class_room.name }}</td>
                                            <td>{{ s.present_count_reported }}</td>

                                            <td>{{ s.unexcused_absent_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'unexcused' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.orvi_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'orvi' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.other_disease_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'other_disease' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>{{ s.family_reason_count }}</td>
                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            {% if a.reason == 'family' %}
                                                                <li class="pill">{{ a.student.full_name }}</li>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>

                                            <td>
                                                {% if s.absent_students.all %}
                                                    <ul class="pill-list">
                                                        {% for a in s.absent_students.all %}
                                                            <li class="pill">{{ a.student.full_name }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="muted">Нет данных</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="muted">За выбранный месяц данных нет.</p>
            {% endif %}
        </div>
    </div>

    {# === СВОДКА ПО КЛАССАМ ЗА МЕСЯЦ === #}
    <div class="card-section" data-section-block="by_class">
        <div class="section-header">
            <h2>Сводка по классам за месяц</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="by-class-section-body">
                Развернуть
            </button>
        </div>

        <div id="by-class-section-body" class="section-body collapsed">
            {% if monthly_by_class %}
                <div class="table-wrapper">
                    <table class="table table-compact">
                        <thead>
                        <tr>
                            <th>Класс</th>
                            <th>Всего пришедших</th>
                            <th>Всего неуважительных</th>
                            <th>ОРВИ</th>
                            <th>Другие заболевания</th>
                            <th>По семейным обстоятельствам</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in monthly_by_class %}
                            <tr data-row-type="by_class"
                                data-class-name="{{ row.class_room__name|lower }}"
                                data-total-unexcused="{{ row.total_unexcused|default:0 }}">
                                <td>{{ row.class_room__name }}</td>
                                <td>{{ row.total_present_reported|default:"0" }}</td>
                                <td>{{ row.total_unexcused|default:"0" }}</td>
                                <td>{{ row.total_orvi|default:"0" }}</td>
                                <td>{{ row.total_other_disease|default:"0" }}</td>
                                <td>{{ row.total_family|default:"0" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="muted">Нет данных для построения сводной таблицы.</p>
            {% endif %}
        </div>
    </div>

    {# === СТАТИСТИКА ПО УЧЕНИКАМ === #}
    <div class="card-section" data-section-block="by_student">
        <div class="section-header">
            <h2>Статистика по ученикам за месяц (неуважительные)</h2>
            <button type="button"
                    class="btn btn-small btn-outline collapse-toggle"
                    data-target-id="by-student-section-body">
                Развернуть
            </button>
        </div>

        <div id="by-student-section-body" class="section-body collapsed">
            {% if per_student %}
                <div class="table-wrapper">
                    <table class="table table-compact">
                        <thead>
                        <tr>
                            <th>Класс</th>
                            <th>ФИО ученика</th>
                            <th>Кол-во неявок</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in per_student %}
                            <tr data-row-type="by_student"
                                data-class-name="{{ row.student__class_room__name|lower }}"
                                data-student-name="{{ row.student__full_name|lower }}"
                                data-absence-count="{{ row.absence_count }}">
                                <td>{{ row.student__class_room__name }}</td>
                                <td>{{ row.student__full_name }}</td>
                                <td>{{ row.absence_count }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="muted">Нет данных по отсутствиям учеников за выбранный месяц.</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="{% static 'attendance/js/statistics.js' %}"></script>
{% endblock %}