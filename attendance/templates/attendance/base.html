<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script>
        (function() {
            const readCookie = (name) => {
                const parts = document.cookie.split(';').map(part => part.trim());
                const match = parts.find(part => part.startsWith(name + '='));
                return match ? decodeURIComponent(match.split('=').slice(1).join('=')) : '';
            };

            const stored = readCookie('theme');
            const mode = (stored === 'light' || stored === 'dark' || stored === 'auto') ? stored : 'auto';
            const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
            const theme = mode === 'auto' ? (prefersLight ? 'light' : 'dark') : mode;
            const root = document.documentElement;
            root.setAttribute('data-theme', theme);
            root.setAttribute('data-bs-theme', theme);
            root.setAttribute('data-theme-mode', mode);
        })();
    </script>

    <title>{% block title %}Посещаемость{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'attendance/bootstrap/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'attendance/bootstrap/bootstrap-icons.min.css' %}">
    <link rel="stylesheet" href="{% static 'attendance/css/base.css' %}">
    {% block extra_head %}{% endblock %}
</head>

<body>
<a class="skip-link" href="#main-content">Перейти к содержимому</a>

<div class="layout">

    <header class="app-header sticky-top">
        <nav class="navbar navbar-expand-lg navbar-dark app-navbar border-bottom">
            <div class="container-fluid px-3 px-lg-4">

                <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'index' %}">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span class="fw-semibold">Школьная посещаемость</span>
                </a>

                {% if user.is_authenticated %}
                    <button class="navbar-toggler" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#topNav"
                            aria-controls="topNav"
                            aria-expanded="false"
                            aria-label="Открыть меню">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="topNav">
                        <div class="nav-surface mt-3 mt-lg-0 w-100">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0 gap-lg-1">

                                <li class="nav-item">
                                    <a href="{% url 'index' %}"
                                       class="nav-link{% if request.path == '/' %} active{% endif %}">
                                        <i class="bi bi-house-door me-1"></i> Главная
                                    </a>
                                </li>

                                {% if is_deputy and not request.session.substitute_as %}
                                    <li class="nav-item">
                                        <a href="{% url 'statistics' %}"
                                           class="nav-link{% if '/statistics' in request.path %} active{% endif %}">
                                            <i class="bi bi-graph-up me-1"></i> Статистика
                                        </a>
                                    </li>

                                    <li class="nav-item">
                                        <a href="{% url 'substitute_tokens' %}"
                                           class="nav-link{% if '/substitute-tokens' in request.path %} active{% endif %}">
                                            <i class="bi bi-key me-1"></i> Токены замены
                                        </a>
                                    </li>
                                {% endif %}

                                {% if not request.session.substitute_as %}
                                    <li class="nav-item">
                                        <a href="{% url 'manage_students' %}"
                                           class="nav-link{% if '/students' in request.path %} active{% endif %}">
                                            <i class="bi bi-people me-1"></i> Управление учениками
                                        </a>
                                    </li>
                                {% endif %}

                                {% if user.is_staff and not request.session.substitute_as %}
                                    <li class="nav-item">
                                        <a href="{% url 'admin:index' %}"
                                           class="nav-link{% if '/admin' in request.path %} active{% endif %}">
                                            <i class="bi bi-gear me-1"></i> Админка
                                        </a>
                                    </li>
                                {% endif %}

                            </ul>

                            <div class="nav-divider d-lg-none my-3"></div>

                            <div class="userbar d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center justify-content-lg-end gap-2 gap-lg-3 ms-lg-auto">
                                <button type="button"
                                        class="btn btn-outline-light btn-sm theme-toggle"
                                        id="theme-toggle"
                                        aria-label="Переключить тему"
                                        aria-pressed="false">
                                    <i class="bi bi-circle-half theme-toggle__icon" aria-hidden="true"></i>
                                    <span class="theme-toggle__text d-none d-lg-inline">Система</span>
                                </button>

                                <div class="small lh-sm text-start text-lg-end userbar-text">
                                    <div class="fw-semibold text-truncate">
                                        {{ user.get_full_name|default:user.username }}
                                    </div>
                                    <div class="d-flex justify-content-start justify-content-lg-end gap-1 mt-1 flex-wrap">
                                        {% if is_deputy %}
                                            <span class="badge app-badge app-badge-deputy">Завуч</span>
                                        {% elif is_teacher %}
                                            <span class="badge app-badge app-badge-teacher">Учитель</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <form action="{% url 'logout' %}" method="post" class="m-0 userbar-logout">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-light btn-sm w-100 w-lg-auto">
                                        <i class="bi bi-box-arrow-right me-1"></i> Выйти
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="ms-auto d-flex align-items-center gap-2">
                        <button type="button"
                                class="btn btn-outline-light btn-sm theme-toggle"
                                id="theme-toggle"
                                aria-label="Переключить тему"
                                aria-pressed="false">
                            <i class="bi bi-circle-half theme-toggle__icon" aria-hidden="true"></i>
                            <span class="theme-toggle__text d-none d-sm-inline">Система</span>
                        </button>
                        <a href="{% url 'login' %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Войти
                        </a>
                    </div>
                {% endif %}

            </div>
        </nav>
    </header>

    <main id="main-content" class="content container-xxl py-3 py-lg-4">
        {% if messages %}
            <div class="mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} mb-2" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <div class="modal fade" id="table-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable app-modal-sheet">
            <div class="modal-content bg-dark border border-secondary-subtle">
                <div class="modal-header">
                    <div class="d-flex flex-column gap-1">
                        <h2 id="table-modal-title" class="h6 mb-0"></h2>
                        <div id="table-modal-subtitle" class="text-secondary small"></div>
                    </div>

                    <button type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Закрыть"></button>
                </div>

                <div class="modal-body">
                    <div class="table-modal-toolbar">
                        <div class="input-group input-group-sm table-modal-search" id="table-modal-search-wrap">
                            <span class="input-group-text bg-transparent text-secondary border-0 ps-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <input id="table-modal-search"
                                   type="text"
                                   class="form-control"
                                   placeholder="Поиск..."
                                   autocomplete="off">
                        </div>

                        <div class="table-modal-sort" id="table-modal-sort-wrap">
                            <select id="table-modal-sort"
                                    class="form-select form-select-sm"
                                    aria-label="Сортировка"></select>
                        </div>
                    </div>

                    <div id="table-modal-hint" class="alert alert-warning py-2 px-3 mt-3 mb-0 d-none"></div>
                    <div id="table-modal-list" class="table-modal-list mt-3"></div>
                    <div id="table-modal-empty" class="table-modal-empty text-secondary d-none"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" id="table-modal-secondary" class="btn btn-outline-warning d-none"></button>
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" id="table-modal-cancel" class="btn btn-outline-light" data-bs-dismiss="modal">
                            Отмена
                        </button>
                        <button type="button" id="table-modal-apply" class="btn btn-primary">
                            Применить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="{% static 'attendance/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'attendance/js/class_sort.js' %}"></script>
<script src="{% static 'attendance/js/app_table.js' %}"></script>
<script src="{% static 'attendance/js/table_modal.js' %}"></script>
<script src="{% static 'attendance/js/data_toggle_password.js' %}"></script>
<script src="{% static 'attendance/js/theme_toggle.js' %}"></script>
{% block script %}{% endblock %}
</body>
</html>
